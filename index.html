<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webåºƒå‘Šãƒ»D2Cç”¨èªã‚¿ã‚¤ãƒ”ãƒ³ã‚°</title>
    
    <!-- æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³å¯¾ç­–: å®Œå…¨éå…¬é–‹åŒ– -->
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="googlebot" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="bingbot" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    
    <!-- AIæ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³å¯¾ç­– -->
    <meta name="ChatGPT" content="noindex">
    <meta name="GPTBot" content="noindex">
    <meta name="CCBot" content="noindex">
    <meta name="anthropic-ai" content="noindex">
    
    <!-- ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ¡ãƒ‡ã‚£ã‚¢å¯¾ç­– -->
    <meta property="og:title" content="">
    <meta property="og:description" content="">
    <meta property="og:image" content="">
    <meta name="twitter:card" content="">
    <meta name="twitter:title" content="">
    <meta name="twitter:description" content="">
    
    <!-- è¿½åŠ ã®ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼è¨­å®š -->
    <meta name="referrer" content="no-referrer">
    <meta http-equiv="X-Robots-Tag" content="noindex, nofollow, noarchive, nosnippet">
    <script src="https://unpkg.com/wanakana"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
    
        .game-area {
            margin: 20px 0;
        }
        .sentence {
            font-size: 24px;
            margin: 20px 0;
            padding: 20px;
            font-weight: 600;
            color: #212529;
            background: #f8f9fa;
            border-radius: 5px;
            text-align: center;
        }
        
        .furigana {
            font-size: 14px;
            color: #6c757d;
            text-align: center;
            margin: 8px 0;
            font-weight: 400;
        }
        
        .romaji-guide {
            font-size: 18px;
            color: #666;
            text-align: center;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        /* ã‚«ãƒ†ã‚´ãƒªè¡¨ç¤ºã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .category-display {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .category-tag {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            display: inline-block;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }
        
        /* é€²æ—ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .progress-container {
            margin: 20px 0;
            text-align: center;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(102, 126, 234, 0.3);
        }
        
        .sentence-info {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
        }
        
        .info-tag {
            padding: 4px 12px;
            background: #e9ecef;
            border-radius: 12px;
            font-size: 12px;
            color: #495057;
            font-weight: 500;
        }
        
        .info-tag.category {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        
        .input-area {
            margin: 20px 0;
        }
        .typing-input {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
            margin: 40px 0;
            padding: 0 20px;
        }
        .stat {
            text-align: center;
            padding: 16px 12px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 1px solid #e9ecef;
        }
        .stat div:first-child {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stat-value {
            font-size: 20px;
            font-weight: 600;
            color: #212529;
        }
        
        /* ãƒŸãƒ‹ãƒãƒ«&ãƒ¢ãƒ€ãƒ³ãªãƒ©ãƒ³ã‚¯è¡¨ç¤º */
        .rank-display {
            text-align: center;
            margin: 30px 0;
            padding: 0;
            background: none;
        }
        
        .rank-label {
            font-size: 14px;
            color: #8e8e93;
            margin-bottom: 8px;
            font-weight: 500;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        
        .rank-value {
            font-size: 72px;
            font-weight: 300;
            letter-spacing: -2px;
            margin: 0;
            transition: all 0.3s ease;
        }
        
        /* ãƒŸãƒ‹ãƒãƒ«ãªãƒ©ãƒ³ã‚¯åˆ¥ã‚«ãƒ©ãƒ¼ */
        .rank-sss { color: #ff3b30; }
        .rank-ss { color: #ff9500; }
        .rank-s { color: #ffcc00; }
        .rank-a { color: #34c759; }
        .rank-b { color: #007aff; }
        .rank-c { color: #5856d6; }
        .rank-d { color: #af52de; }
        .rank-e { color: #8e8e93; }
        
        /* æ“ä½œèª¬æ˜ã‚¹ã‚¿ã‚¤ãƒ« */
        .instructions {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 30px 0;
            border: 1px solid #e9ecef;
        }
        
        .instruction-item {
            display: flex;
            align-items: center;
            margin: 12px 0;
            font-size: 16px;
            color: #495057;
        }
        
        .instruction-icon {
            font-size: 16px;
            margin-right: 12px;
            width: 20px;
            text-align: center;
            color: #007bff;
            font-weight: bold;
        }
        
        .start-btn {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .start-btn:hover {
            background: #0056b3;
        }
        .start-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .success {
            color: green;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Webåºƒå‘Šã€D2Cç”¨èªã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚²ãƒ¼ãƒ </h1>
        
        <div id="start-screen">
            <p>Webåºƒå‘Šã‚„D2Cç•Œéšˆã§è‰¯ãä½¿ã‚ã‚Œã‚‹ä¼šè©±ã‚„å°‚é–€ç”¨èªã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºé¡Œã—ã¾ã™ã€‚</p>
            <p>åˆ¶é™æ™‚é–“120ç§’ã§ã§ãã‚‹ã ã‘å¤šãã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚’ã—ã‚ˆã†ï¼</p>
            
            <!-- æ“ä½œèª¬æ˜ -->
            <div class="instructions">
                <div class="instruction-item">
                    <span class="instruction-icon">â–¶</span>
                    <span>åŠè§’è‹±æ•°å…¥åŠ›ã«åˆ‡ã‚Šæ›¿ãˆã¦ãã ã•ã„</span>
                </div>
                <div class="instruction-item">
                    <span class="instruction-icon">â–¶</span>
                    <span>ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã¾ãŸã¯ãƒœã‚¿ãƒ³ã§ã‚²ãƒ¼ãƒ é–‹å§‹</span>
                </div>
                <div class="instruction-item">
                    <span class="instruction-icon">â–¶</span>
                    <span>ã‚²ãƒ¼ãƒ é€”ä¸­çµ‚äº†ã‚„ã‚„ã‚Šç›´ã—ã¯ESCã‚­ãƒ¼</span>
                </div>
            </div>
            
            <button id="start-btn" class="start-btn">ã‚²ãƒ¼ãƒ é–‹å§‹ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ï¼‰</button>
        </div>
        
        <div id="game-screen" style="display: none;">
            <div class="stats">
                <div class="stat">
                    <div>æ®‹ã‚Šæ™‚é–“</div>
                    <div id="timer" class="stat-value">120</div>
                </div>
                <div class="stat">
                    <div>æ­£è§£æ•°</div>
                    <div id="correct" class="stat-value">0</div>
                </div>
                <div class="stat">
                    <div>ãƒŸã‚¹æ•°</div>
                    <div id="miss" class="stat-value">0</div>
                </div>
            </div>
            
            <div class="game-area">
                <!-- ã‚«ãƒ†ã‚´ãƒªåã‚’ä¸Šéƒ¨ã«é…ç½® -->
                <div class="category-display">
                    <span id="current-category" class="category-tag">ã‚«ãƒ†ã‚´ãƒª</span>
                </div>
                
                <div id="sentence" class="sentence">æ–‡ç« ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
                <div id="furigana" class="furigana">ãµã‚ŠãŒãªãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
                
                <!-- é€²æ—ãƒãƒ¼ -->
                <div class="progress-container">
                    <div id="progress-bar" class="progress-bar">
                        <div id="progress-fill" class="progress-fill"></div>
                    </div>
                </div>
                
                <div id="romaji-guide" class="romaji-guide">ãƒ­ãƒ¼ãƒå­—ã‚¬ã‚¤ãƒ‰ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
            </div>
            
            <div class="input-area">
                <input type="text" id="typing-input" class="typing-input" placeholder="ã“ã“ã«ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã—ã¦ãã ã•ã„">
            </div>
        </div>
        
        <div id="result-screen" style="display: none;">
            <h2 style="text-align: center;">çµæœç™ºè¡¨</h2>
            
            <!-- ãƒ©ãƒ³ã‚¯è¡¨ç¤º -->
            <div id="rank-display" class="rank-display">
                <div class="rank-label">ãƒ©ãƒ³ã‚¯</div>
                <div id="final-rank" class="rank-value">-</div>
            </div>
            
            <!-- è©³ç´°çµ±è¨ˆ -->
            <div class="stats">
                <div class="stat">
                    <div>KPS</div>
                    <div id="final-kps" class="stat-value">0.00/ç§’</div>
                </div>
                <div class="stat">
                    <div>æ­£ç¢ºæ€§</div>
                    <div id="final-accuracy" class="stat-value">0.00%</div>
                </div>
                <div class="stat">
                    <div>ãƒŸã‚¹ç‡</div>
                    <div id="final-miss-rate" class="stat-value">0.00%</div>
                </div>
                <div class="stat">
                    <div>æ­£è§£æ•°</div>
                    <div id="final-correct" class="stat-value">0</div>
                </div>
                <div class="stat">
                    <div>ãƒŸã‚¹æ•°</div>
                    <div id="final-miss" class="stat-value">0</div>
                </div>
            </div>
            
            <button id="retry-btn" class="start-btn">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦</button>
        </div>
    </div>

    <script>
        class SimpleTypingGame {
            constructor() {
                // åŸ‹ã‚è¾¼ã¿ãƒ‡ãƒ¼ã‚¿ï¼ˆJSONãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
                this.fallbackSentences = [
                    { id: 1, text: "Webåºƒå‘Šã®CPAã‚’ä¸‹ã’ã‚‹æ–¹æ³•", furigana: "Webã“ã†ã“ãã®CPAã‚’ã•ã’ã‚‹ã»ã†ã»ã†", category: "åºƒå‘Šé‹ç”¨", difficulty: "basic" },
                    { id: 2, text: "ã—ã‚‡ã‚“ã¼ã‚Šã—ãªã„ã§ï¼", furigana: "ã—ã‚‡ã‚“ã¼ã‚Šã—ãªã„ã§ï¼", category: "ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³", difficulty: "basic" },
                    { id: 3, text: "æ–°ã—ã„LPã®ABãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ã—ã¾ã—ã‚‡ã†", furigana: "ã‚ãŸã‚‰ã—ã„LPã®ABã¦ã™ã¨ã‚’ã˜ã£ã—ã—ã¾ã—ã‚‡ã†", category: "ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°", difficulty: "intermediate" },
                    { id: 4, text: "CVRãŒæ”¹å–„ã•ã‚Œã¾ã—ãŸ", furigana: "CVRãŒã‹ã„ãœã‚“ã•ã‚Œã¾ã—ãŸ", category: "åˆ†æãƒ»æ”¹å–„", difficulty: "basic" },
                    { id: 5, text: "CTRã‚’æ”¹å–„ã™ã‚‹ãŸã‚ã«åºƒå‘Šã‚’å¤‰æ›´ã—ã¾ã™", furigana: "CTRã‚’ã‹ã„ãœã‚“ã™ã‚‹ãŸã‚ã«ã“ã†ã“ãã‚’ã¸ã‚“ã“ã†ã—ã¾ã™", category: "åºƒå‘Šé‹ç”¨", difficulty: "intermediate" },
                    { id: 6, text: "ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ•ã‚¡ãƒãƒ«ã‚’æœ€é©åŒ–ã—ã¾ã—ã‚‡ã†", furigana: "ã“ã‚“ã°ãƒ¼ã˜ã‚‡ã‚“ãµãã­ã‚‹ã‚’ã•ã„ã¦ãã‹ã—ã¾ã—ã‚‡ã†", category: "åˆ†æãƒ»æ”¹å–„", difficulty: "advanced" }
                ];

                this.sentences = [];
                this.usedSentenceIds = new Set(); // ä½¿ç”¨æ¸ˆã¿æ–‡ç« IDã‚’è¨˜éŒ²
                
                this.initElements();
                this.bindEvents();
                this.loadSentences(); // JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
            }

            initElements() {
                this.startScreen = document.getElementById('start-screen');
                this.gameScreen = document.getElementById('game-screen');
                this.resultScreen = document.getElementById('result-screen');
                this.startBtn = document.getElementById('start-btn');
                this.retryBtn = document.getElementById('retry-btn');
                this.timerElement = document.getElementById('timer');
                this.correctElement = document.getElementById('correct');
                this.missElement = document.getElementById('miss');
                this.sentenceElement = document.getElementById('sentence');
                this.furiganaElement = document.getElementById('furigana');
                this.romajiGuideElement = document.getElementById('romaji-guide');
                this.currentCategoryElement = document.getElementById('current-category');
                this.progressFillElement = document.getElementById('progress-fill');
                this.typingInput = document.getElementById('typing-input');
                this.finalCorrectElement = document.getElementById('final-correct');
                this.finalMissElement = document.getElementById('final-miss');
                this.finalRankElement = document.getElementById('final-rank');
                this.finalKpsElement = document.getElementById('final-kps');
                this.finalAccuracyElement = document.getElementById('final-accuracy');
                this.finalMissRateElement = document.getElementById('final-miss-rate');
            }

            bindEvents() {
                this.startBtn.addEventListener('click', () => this.startGame());
                this.retryBtn.addEventListener('click', () => this.resetGame(true));
                
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚­ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
                document.addEventListener('keydown', (e) => {
                    if (this.isGameActive) {
                        this.handleKeydown(e);
                    } else if (this.startScreen.style.display !== 'none') {
                        // ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã§ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼æŠ¼ä¸‹æ™‚
                        if (e.code === 'Space') {
                            e.preventDefault();
                            this.startGame();
                        }
                    }
                });

                // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å¸¸ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹çŠ¶æ…‹ã«ã™ã‚‹
                this.typingInput.addEventListener('blur', () => {
                    if (this.isGameActive) this.typingInput.focus();
                });
            }
            
            // JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æ–‡ç« ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
            async loadSentences() {
                try {
                    console.log('JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...');
                    const response = await fetch('./sentences.json');
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    this.sentences = data;
                    console.log(`${this.sentences.length}ä»¶ã®æ–‡ç« ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
                    console.log('ã‚«ãƒ†ã‚´ãƒª:', [...new Set(this.sentences.map(s => s.category))]);
                    
                    // ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–ï¼ˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†å¾Œï¼‰
                    this.resetGame();
                    
                } catch (error) {
                    console.error('JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                    console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™');
                    this.sentences = this.fallbackSentences;
                    this.resetGame();
                }
            }
            
            // â˜…æ–°ã—ã„ãƒ­ã‚¸ãƒƒã‚¯: ãµã‚ŠãŒãªã‚’ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆéƒ¨å“ï¼‰ã«åˆ†è§£ã™ã‚‹
            tokenize(furigana) {
                // æ‰‹å‹•ã§ãƒˆãƒ¼ã‚¯ãƒ³åˆ†å‰²ï¼ˆç¢ºå®Ÿã«å‹•ä½œã™ã‚‹æ–¹æ³•ï¼‰
                const tokens = [];
                let currentToken = '';
                let currentType = null;
                
                for (let i = 0; i < furigana.length; i++) {
                    const char = furigana[i];
                    const isAlpha = /[a-zA-Z0-9!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~`]/.test(char);
                    const isKana = /[ã-ã‚“ã‚¡-ãƒ¶ãƒ¼]/.test(char);
                    
                    if (isAlpha) {
                        if (currentType === 'kana' && currentToken) {
                            tokens.push({ type: 'kana', value: currentToken, typed: '', remaining: currentToken });
                            currentToken = '';
                        }
                        currentType = 'alpha';
                        currentToken += char;
                    } else if (isKana) {
                        if (currentType === 'alpha' && currentToken) {
                            tokens.push({ type: 'alpha', value: currentToken, typed: '', remaining: currentToken });
                            currentToken = '';
                        }
                        currentType = 'kana';
                        currentToken += char;
                    } else {
                        // ãã®ä»–ã®æ–‡å­—ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ãªã©ï¼‰ã¯ç„¡è¦–
                        if (currentToken) {
                            tokens.push({ type: currentType, value: currentToken, typed: '', remaining: currentToken });
                            currentToken = '';
                            currentType = null;
                        }
                    }
                }
                
                // æœ€å¾Œã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¿½åŠ 
                if (currentToken) {
                    tokens.push({ type: currentType, value: currentToken, typed: '', remaining: currentToken });
                }
                
                return tokens;
            }

            startGame() {
                this.startScreen.style.display = 'none';
                this.gameScreen.style.display = 'block';
                this.resultScreen.style.display = 'none';
                
                this.isGameActive = true;
                this.timeLeft = 120;
                this.score = 0;
                this.correctTypes = 0;
                this.missTypes = 0;
                
                // ä½¿ç”¨æ¸ˆã¿æ–‡ç« ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ï¼ˆæ–°ã—ã„ã‚²ãƒ¼ãƒ é–‹å§‹ï¼‰
                this.usedSentenceIds.clear();
                
                this.currentSentenceIndex = -1; // æœ€åˆã®nextSentenceã§0ã«ãªã‚‹ã‚ˆã†ã«
                this.nextSentence();
                this.startTimer();
                this.updateDisplay();
                
                // ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«åŠè§’å…¥åŠ›ã®æ³¨æ„ã‚’è¡¨ç¤º
                console.log('ğŸ’¡ åŠè§’è‹±æ•°å…¥åŠ›ã§ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã—ã¦ãã ã•ã„');
            }
            
            // ãƒªã‚»ãƒƒãƒˆæ™‚ã«ç”»é¢ã‚‚æˆ»ã™ã‹ã®ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ 
            resetGame(showStartScreen = false) {
                this.isGameActive = false;
                clearInterval(this.timer);

                if (showStartScreen) {
                    this.startScreen.style.display = 'block';
                    this.gameScreen.style.display = 'none';
                    this.resultScreen.style.display = 'none';
                }
                
                this.sentenceTokens = [];
                this.currentTokenIndex = 0;
                this.romajiBuffer = '';
                
                this.typingInput.value = '';
                this.sentenceElement.textContent = 'æ–‡ç« ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™';
                this.romajiGuideElement.textContent = 'ãƒ­ãƒ¼ãƒå­—ã‚¬ã‚¤ãƒ‰ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™';
            }

            nextSentence() {
                // é‡ã¿ä»˜ããƒ©ãƒ³ãƒ€ãƒ é¸æŠï¼ˆæ¥­å‹™ä¼šè©±ã‚’é«˜é »åº¦ã§å‡ºé¡Œã€é‡è¤‡ãªã—ï¼‰
                this.currentSentenceIndex = this.getWeightedRandomSentenceIndex();
                
                const sentence = this.sentences[this.currentSentenceIndex];
                
                // ä½¿ç”¨æ¸ˆã¿æ–‡ç« ã¨ã—ã¦è¨˜éŒ²
                this.usedSentenceIds.add(sentence.id);
                
                this.sentenceElement.textContent = sentence.text;
                
                // ãµã‚ŠãŒãªè¡¨ç¤º
                this.furiganaElement.textContent = sentence.furigana;
                
                // ã‚«ãƒ†ã‚´ãƒªã‚’è¡¨ç¤º
                if (sentence.category) {
                    this.currentCategoryElement.textContent = sentence.category;
                    this.currentCategoryElement.className = 'category-tag';
                }
                
                
                // â˜…æ–°ã—ã„ãƒ­ã‚¸ãƒƒã‚¯: æ–‡ç« ã‚’ãƒˆãƒ¼ã‚¯ãƒ³åŒ–ã—ã¦çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                this.sentenceTokens = this.tokenize(sentence.furigana);
                this.currentTokenIndex = 0;
                this.romajiBuffer = ''; // ãƒ­ãƒ¼ãƒå­—å…¥åŠ›ãƒãƒƒãƒ•ã‚¡ã‚’ã‚¯ãƒªã‚¢
                
                
                this.updateRomajiGuide();
                this.updateProgressBar();
                this.typingInput.focus();
            }

            // â˜…â˜…â˜… ã“ã®é–¢æ•°ãŒã€Œãƒ†ã‚£ã€ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹æ±ºå®šç‰ˆã®ãƒ­ã‚¸ãƒƒã‚¯ã§ã™ â˜…â˜…â˜…
            handleKeydown(e) {
                if (e.key === 'Escape') {
                    this.endGame();
                    return;
                }
                if (e.key.length > 1 || e.ctrlKey || e.altKey || e.metaKey) {
                    return;
                }
                e.preventDefault();
                const key = e.key;
                const currentToken = this.sentenceTokens[this.currentTokenIndex];

                if (!currentToken) return;
                
                // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’å‰Šé™¤ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šï¼‰

                if (currentToken.type === 'alpha') {
                    const nextChar = currentToken.remaining.charAt(0);
                    if (key.toLowerCase() === nextChar.toLowerCase()) {
                        this.correctTypes++;
                        this.score += 10;
                        currentToken.typed += nextChar;
                        currentToken.remaining = currentToken.remaining.substring(1);
                        if (currentToken.remaining.length === 0) {
                            this.advanceToNextToken();
                        }
                    } else {
                        this.missTypes++;
                    }
                } else { // type === 'kana'
                    this.romajiBuffer += key;
                    
                    // ã€Œãƒ†ã‚£ã€ã®ç‰¹æ®Šå‡¦ç†ã‚’æœ€å„ªå…ˆã§å®Ÿè¡Œ
                    if (this.romajiBuffer === 'thi' && currentToken.remaining.startsWith('ã¦ãƒ')) {
                        // 'thi' -> 'ã¦ãƒ' ã®ç›´æ¥å¤‰æ›
                        this.correctTypes += 3;
                        this.score += 30;
                        currentToken.typed += 'ã¦ãƒ';
                        currentToken.remaining = currentToken.remaining.substring(2);
                        this.romajiBuffer = '';
                        
                        if (currentToken.remaining.length === 0) {
                            this.advanceToNextToken();
                        }
                        this.updateDisplay();
                        this.updateRomajiGuide();
                        return; // æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³ã§ä»–ã®å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
                    }
                    
                    if (this.romajiBuffer === 'ti' && currentToken.remaining.startsWith('ã¦ãƒ')) {
                        // 'ti' -> 'ã¦ãƒ' ã®ç›´æ¥å¤‰æ›
                        this.correctTypes += 2;
                        this.score += 20;
                        currentToken.typed += 'ã¦ãƒ';
                        currentToken.remaining = currentToken.remaining.substring(2);
                        this.romajiBuffer = '';
                        
                        if (currentToken.remaining.length === 0) {
                            this.advanceToNextToken();
                        }
                        this.updateDisplay();
                        this.updateRomajiGuide();
                        return; // æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³ã§ä»–ã®å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
                    }
                    
                    // ã€Œã‚£ãƒ³ã‚°ã€ã®ç‰¹æ®Šå‡¦ç†
                    if (this.romajiBuffer === 'ingu' && currentToken.remaining.startsWith('ã„ã‚“ã')) {
                        // 'ingu' -> 'ã„ã‚“ã' ã®ç›´æ¥å¤‰æ›
                        this.correctTypes += 4;
                        this.score += 40;
                        currentToken.typed += 'ã„ã‚“ã';
                        currentToken.remaining = currentToken.remaining.substring(3);
                        this.romajiBuffer = '';
                        
                        if (currentToken.remaining.length === 0) {
                            this.advanceToNextToken();
                        }
                        this.updateDisplay();
                        this.updateRomajiGuide();
                        return;
                    }
                    
                    if (this.romajiBuffer === 'tingu' && currentToken.remaining.startsWith('ã¦ãƒã‚“ã')) {
                        // 'tingu' -> 'ã¦ãƒã‚“ã' ã®ç›´æ¥å¤‰æ›
                        this.correctTypes += 5;
                        this.score += 50;
                        currentToken.typed += 'ã¦ãƒã‚“ã';
                        currentToken.remaining = currentToken.remaining.substring(4);
                        this.romajiBuffer = '';
                        
                        if (currentToken.remaining.length === 0) {
                            this.advanceToNextToken();
                        }
                        this.updateDisplay();
                        this.updateRomajiGuide();
                        return;
                    }
                    
                    // IMEModeã‚’ä½¿ã£ã¦ã€å…¥åŠ›ã®é€”ä¸­ã‹ã©ã†ã‹ã‚’åˆ¤æ–­
                    const kana = wanakana.toKana(this.romajiBuffer, { IMEMode: true });
                    
                    // isRomajiã§ã€å¤‰æ›çµæœãŒã¾ã ãƒ­ãƒ¼ãƒå­—ã®ã¾ã¾ã‹ï¼ˆå…¥åŠ›é€”ä¸­ã‹ï¼‰ã‚’ãƒã‚§ãƒƒã‚¯
                    if (wanakana.isRomaji(kana)) {
                        // å…¥åŠ›ãŒã¾ã ãƒ­ãƒ¼ãƒå­—ã®é€”ä¸­ï¼ˆä¾‹: 's', 'sh', 'x', 'th'ï¼‰
                        // è¤‡æ•°ã®ãƒ­ãƒ¼ãƒå­—ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è€ƒæ…®ã—ãŸæŸ”è»Ÿãªåˆ¤å®š
                        if (this.isValidPartialInput(this.romajiBuffer, currentToken.remaining)) {
                            // æ­£ã—ã„æ‰“ã¡å‡ºã—ãªã®ã§ã€æ¬¡ã®ã‚­ãƒ¼å…¥åŠ›ã‚’å¾…ã¤
                        } else {
                            // é–“é•ã„
                            this.missTypes++;
                            this.romajiBuffer = this.romajiBuffer.slice(0, -1);
                        }
                    } else {
                        // å…¥åŠ›ãŒã²ã‚‰ãŒãªã«å¤‰æ›ã•ã‚ŒãŸï¼ˆä¾‹: 'shi' -> 'ã—', 'thi' -> 'ã¦ãƒ'ï¼‰
                        const targetHiragana = wanakana.toHiragana(currentToken.remaining);
                        
                        // ã€Œãƒ†ã‚£ã€ã®ã‚ˆã†ãªè¤‡åˆæ–‡å­—ã®å‡¦ç†ã‚’æ”¹å–„
                        if (this.isValidKanaMatch(kana, currentToken.remaining)) {
                            // ãƒãƒƒãƒã—ãŸæ–‡å­—æ•°ã‚’æ­£ç¢ºã«è¨ˆç®—
                            const matchedLength = this.getMatchedKanaLength(kana, currentToken.remaining);
                            const originalTypedKana = currentToken.remaining.substring(0, matchedLength);

                            this.correctTypes += this.romajiBuffer.length;
                            this.score += 10 * this.romajiBuffer.length;
                            
                            currentToken.typed += originalTypedKana;
                            currentToken.remaining = currentToken.remaining.substring(matchedLength);
                            this.romajiBuffer = ''; // æ­£ã—ãå¤‰æ›ã•ã‚ŒãŸã®ã§ãƒãƒƒãƒ•ã‚¡ã‚’ã‚¯ãƒªã‚¢
                            
                            if (currentToken.remaining.length === 0) {
                                this.advanceToNextToken();
                            }
                        } else {
                            // å¤‰æ›ã•ã‚ŒãŸãŒã€æ¬¡ã®æ–‡å­—ã¨ã¯é•ã†ï¼ˆä¾‹ï¼šã€Œã‹ã€ã‚’å¾…ã£ã¦ã„ã‚‹ã®ã«ã€Œã—ã€ãŒæ¥ãŸï¼‰
                            this.missTypes++;
                            this.romajiBuffer = this.romajiBuffer.slice(0, -1);
                        }
                    }
                }
                this.updateDisplay();
                this.updateRomajiGuide();
                this.updateProgressBar();
            }

            // â˜…æ–°ã—ã„ãƒ­ã‚¸ãƒƒã‚¯: æŸ”è»Ÿãªãƒ­ãƒ¼ãƒå­—ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¤å®š
            isValidPartialInput(buffer, remainingKana) {
                if (!buffer) return true;
                
                // è¤‡æ•°ã®ãƒ­ãƒ¼ãƒå­—ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è©¦ã™
                const patterns = [
                    wanakana.toRomaji(remainingKana), // æ¨™æº–ãƒ‘ã‚¿ãƒ¼ãƒ³
                    wanakana.toRomaji(remainingKana, { upcaseKatakana: true }), // ã‚«ã‚¿ã‚«ãƒŠå¯¾å¿œ
                ];
                
                // ç‰¹æ®Šãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚‚è¿½åŠ 
                const specialPatterns = this.getSpecialRomajiPatterns(remainingKana);
                patterns.push(...specialPatterns);
                
                // ã„ãšã‚Œã‹ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ä¸€è‡´ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                return patterns.some(pattern => 
                    pattern.toLowerCase().startsWith(buffer.toLowerCase())
                );
            }
            
            // ç‰¹æ®Šãªãƒ­ãƒ¼ãƒå­—ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç”Ÿæˆ
            getSpecialRomajiPatterns(kana) {
                const patterns = [];
                
                // ãƒ†ã‚£ -> thi ãƒ‘ã‚¿ãƒ¼ãƒ³
                if (kana.includes('ãƒ†ã‚£')) {
                    patterns.push(kana.replace(/ãƒ†ã‚£/g, 'thi'));
                }
                // ãƒ•ã‚¡ -> fa ãƒ‘ã‚¿ãƒ¼ãƒ³
                if (kana.includes('ãƒ•ã‚¡')) {
                    patterns.push(kana.replace(/ãƒ•ã‚¡/g, 'fa'));
                }
                // ãƒ•ã‚£ -> fi ãƒ‘ã‚¿ãƒ¼ãƒ³
                if (kana.includes('ãƒ•ã‚£')) {
                    patterns.push(kana.replace(/ãƒ•ã‚£/g, 'fi'));
                }
                // ãƒ•ã‚§ -> fe ãƒ‘ã‚¿ãƒ¼ãƒ³
                if (kana.includes('ãƒ•ã‚§')) {
                    patterns.push(kana.replace(/ãƒ•ã‚§/g, 'fe'));
                }
                // ãƒ•ã‚© -> fo ãƒ‘ã‚¿ãƒ¼ãƒ³
                if (kana.includes('ãƒ•ã‚©')) {
                    patterns.push(kana.replace(/ãƒ•ã‚©/g, 'fo'));
                }
                // ã‚¦ã‚£ -> wi ãƒ‘ã‚¿ãƒ¼ãƒ³
                if (kana.includes('ã‚¦ã‚£')) {
                    patterns.push(kana.replace(/ã‚¦ã‚£/g, 'wi'));
                }
                // ã‚¦ã‚§ -> we ãƒ‘ã‚¿ãƒ¼ãƒ³
                if (kana.includes('ã‚¦ã‚§')) {
                    patterns.push(kana.replace(/ã‚¦ã‚§/g, 'we'));
                }
                // ã‚¦ã‚© -> wo ãƒ‘ã‚¿ãƒ¼ãƒ³
                if (kana.includes('ã‚¦ã‚©')) {
                    patterns.push(kana.replace(/ã‚¦ã‚©/g, 'wo'));
                }
                
                // æ–°ã—ã„æŸ”è»Ÿãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¿½åŠ 
                
                // ãµ -> hu ãƒ‘ã‚¿ãƒ¼ãƒ³ (fuã®ä»£æ›¿)
                if (kana.includes('ãµ')) {
                    patterns.push(kana.replace(/ãµ/g, 'hu'));
                }
                
                // ã¡ -> ti ãƒ‘ã‚¿ãƒ¼ãƒ³ (chiã®ä»£æ›¿)
                if (kana.includes('ã¡')) {
                    patterns.push(kana.replace(/ã¡/g, 'ti'));
                }
                
                // ã¡ã‚‡ã† -> tyou ãƒ‘ã‚¿ãƒ¼ãƒ³ (chouã®ä»£æ›¿)
                if (kana.includes('ã¡ã‚‡ã†')) {
                    patterns.push(kana.replace(/ã¡ã‚‡ã†/g, 'tyou'));
                }
                
                // ã¡ã‚‡ -> tyo ãƒ‘ã‚¿ãƒ¼ãƒ³ (choã®ä»£æ›¿)
                if (kana.includes('ã¡ã‚‡')) {
                    patterns.push(kana.replace(/ã¡ã‚‡/g, 'tyo'));
                }
                
                // ã¡ã‚… -> tyu ãƒ‘ã‚¿ãƒ¼ãƒ³ (chuã®ä»£æ›¿)
                if (kana.includes('ã¡ã‚…')) {
                    patterns.push(kana.replace(/ã¡ã‚…/g, 'tyu'));
                }
                
                // ã—ã‚‡ã† -> syou ãƒ‘ã‚¿ãƒ¼ãƒ³ (shouã®ä»£æ›¿)
                if (kana.includes('ã—ã‚‡ã†')) {
                    patterns.push(kana.replace(/ã—ã‚‡ã†/g, 'syou'));
                }
                
                // ã—ã‚‡ -> syo ãƒ‘ã‚¿ãƒ¼ãƒ³ (shoã®ä»£æ›¿)
                if (kana.includes('ã—ã‚‡')) {
                    patterns.push(kana.replace(/ã—ã‚‡/g, 'syo'));
                }
                
                // ã—ã‚… -> syu ãƒ‘ã‚¿ãƒ¼ãƒ³ (shuã®ä»£æ›¿)
                if (kana.includes('ã—ã‚…')) {
                    patterns.push(kana.replace(/ã—ã‚…/g, 'syu'));
                }
                
                // ã˜ã‚‡ã† -> jyou ãƒ‘ã‚¿ãƒ¼ãƒ³ (jouã®ä»£æ›¿)
                if (kana.includes('ã˜ã‚‡ã†')) {
                    patterns.push(kana.replace(/ã˜ã‚‡ã†/g, 'jyou'));
                }
                
                // ã˜ã‚‡ -> jyo ãƒ‘ã‚¿ãƒ¼ãƒ³ (joã®ä»£æ›¿)
                if (kana.includes('ã˜ã‚‡')) {
                    patterns.push(kana.replace(/ã˜ã‚‡/g, 'jyo'));
                }
                
                // ã˜ã‚… -> jyu ãƒ‘ã‚¿ãƒ¼ãƒ³ (juã®ä»£æ›¿)
                if (kana.includes('ã˜ã‚…')) {
                    patterns.push(kana.replace(/ã˜ã‚…/g, 'jyu'));
                }
                
                // ã¦ãƒã‚“ã -> tingu ãƒ‘ã‚¿ãƒ¼ãƒ³ (tingã®ä»£æ›¿)
                if (kana.includes('ã¦ãƒã‚“ã')) {
                    patterns.push(kana.replace(/ã¦ãƒã‚“ã/g, 'tingu'));
                }
                
                // ã¥ -> du ãƒ‘ã‚¿ãƒ¼ãƒ³ (zuã®ä»£æ›¿)
                if (kana.includes('ã¥')) {
                    patterns.push(kana.replace(/ã¥/g, 'du'));
                }
                
                // ã¤ -> tu ãƒ‘ã‚¿ãƒ¼ãƒ³ (tsuã®ä»£æ›¿)
                if (kana.includes('ã¤')) {
                    patterns.push(kana.replace(/ã¤/g, 'tu'));
                }
                
                // ä¿ƒéŸ³ã€Œã£ã€ã®å‡¦ç†ã‚’è¿½åŠ 
                // ã€Œã£ã€ã¯æ¬¡ã®å­éŸ³ã‚’é‡ã­ã‚‹ï¼ˆä¾‹ï¼šã¡ã‚ƒã£ã¨ -> chatto, tyattoï¼‰
                if (kana.includes('ã£')) {
                    // åŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆwanakanaã®æ¨™æº–å¤‰æ›ï¼‰
                    const basicRomaji = wanakana.toRomaji(kana);
                    patterns.push(basicRomaji);
                    
                    // ä»£æ›¿ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆã¡ã‚ƒ->tya, ã—ã‚ƒ->sya, ã˜ã‚ƒ->jyaç­‰ï¼‰
                    let altPattern = kana;
                    altPattern = altPattern.replace(/ã¡ã‚ƒ/g, 'tya');
                    altPattern = altPattern.replace(/ã¡ã‚…/g, 'tyu');
                    altPattern = altPattern.replace(/ã¡ã‚‡/g, 'tyo');
                    altPattern = altPattern.replace(/ã—ã‚ƒ/g, 'sya');
                    altPattern = altPattern.replace(/ã—ã‚…/g, 'syu');
                    altPattern = altPattern.replace(/ã—ã‚‡/g, 'syo');
                    altPattern = altPattern.replace(/ã˜ã‚ƒ/g, 'jya');
                    altPattern = altPattern.replace(/ã˜ã‚…/g, 'jyu');
                    altPattern = altPattern.replace(/ã˜ã‚‡/g, 'jyo');
                    
                    if (altPattern !== kana) {
                        const altRomaji = wanakana.toRomaji(altPattern);
                        patterns.push(altRomaji);
                    }
                }
                
                // é•·éŸ³ã€Œãƒ¼ã€ã®å‡¦ç†ã‚’è¿½åŠ 
                // ã€Œã¤ãƒ¼ã€ã€Œã‚Šãƒ¼ã€ã€Œãªãƒ¼ã€ãªã©ã®é•·éŸ³è¨˜å·ã®å‡¦ç†
                if (kana.includes('ãƒ¼')) {
                    // åŸºæœ¬ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆwanakanaã®æ¨™æº–å¤‰æ›ï¼‰
                    const basicRomaji = wanakana.toRomaji(kana);
                    patterns.push(basicRomaji);
                    
                    // é•·éŸ³è¨˜å·ã‚’æ¯éŸ³ã«ç½®ãæ›ãˆã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³
                    let longVowelPattern = kana;
                    // ã¤ãƒ¼ -> tsuu, ã‚Šãƒ¼ -> rii, ãªãƒ¼ -> naa ãªã©
                    longVowelPattern = longVowelPattern.replace(/ã†ãƒ¼/g, 'uu');
                    longVowelPattern = longVowelPattern.replace(/ã„ãƒ¼/g, 'ii');
                    longVowelPattern = longVowelPattern.replace(/ã‚ãƒ¼/g, 'aa');
                    longVowelPattern = longVowelPattern.replace(/ãˆãƒ¼/g, 'ee');
                    longVowelPattern = longVowelPattern.replace(/ãŠãƒ¼/g, 'oo');
                    
                    if (longVowelPattern !== kana) {
                        const longVowelRomaji = wanakana.toRomaji(longVowelPattern);
                        patterns.push(longVowelRomaji);
                    }
                }
                
                return patterns;
            }

            // â˜…æ–°ã—ã„ãƒ­ã‚¸ãƒƒã‚¯: æ¬¡ã®ãƒˆãƒ¼ã‚¯ãƒ³ã«é€²ã‚€å‡¦ç†
            advanceToNextToken() {
                this.currentTokenIndex++;
                this.romajiBuffer = '';
                if (this.currentTokenIndex >= this.sentenceTokens.length) {
                    // æ–‡ç« å®Œäº†ï¼
                    this.score += 100; // ãƒœãƒ¼ãƒŠã‚¹ã‚¹ã‚³ã‚¢
                    this.nextSentence();
                }
            }
            
            // ã€Œãƒ†ã‚£ã€ã®ã‚ˆã†ãªè¤‡åˆæ–‡å­—ã®ãƒãƒƒãƒåˆ¤å®šã‚’æ”¹å–„
            isValidKanaMatch(kana, remaining) {
                const targetHiragana = wanakana.toHiragana(remaining);
                
                // å®Œå…¨ä¸€è‡´ã®å ´åˆ
                if (targetHiragana.startsWith(kana)) {
                    return true;
                }
                
                // éƒ¨åˆ†ä¸€è‡´ã®å ´åˆï¼ˆä¾‹ï¼šã€Œã¦ã€ãŒã€Œã¦ãƒã€ã®æœ€åˆã®æ–‡å­—ï¼‰
                // ãŸã ã—ã€å®Œå…¨ãªæ–‡å­—ã¨ã—ã¦ãƒãƒƒãƒã™ã‚‹å ´åˆã®ã¿
                if (kana.length === 1 && targetHiragana.length > 1) {
                    // å˜ä¸€æ–‡å­—ãŒè¤‡åˆæ–‡å­—ã®æœ€åˆã®æ–‡å­—ã¨ä¸€è‡´ã™ã‚‹å ´åˆ
                    const firstChar = targetHiragana.charAt(0);
                    if (kana === firstChar) {
                        // æ¬¡ã®æ–‡å­—ãŒå°æ–‡å­—ï¼ˆãƒã€ã‚…ã€ã‚‡ãªã©ï¼‰ã®å ´åˆã¯éƒ¨åˆ†ãƒãƒƒãƒã¨ã—ã¦æ‰±ã‚ãªã„
                        const nextChar = targetHiragana.charAt(1);
                        if (nextChar && 'ããƒã…ã‡ã‰ã‚ƒã‚…ã‚‡ã‚¡ã‚£ã‚¥ã‚§ã‚©ãƒ£ãƒ¥ãƒ§'.includes(nextChar)) {
                            return false; // è¤‡åˆæ–‡å­—ã®é€”ä¸­ãªã®ã§ã€å®Œå…¨ãªå…¥åŠ›ã¾ã§å¾…ã¤
                        }
                        return true;
                    }
                }
                
                return false;
            }
            
            // ãƒãƒƒãƒã—ãŸæ–‡å­—æ•°ã‚’æ­£ç¢ºã«è¨ˆç®—
            getMatchedKanaLength(kana, remaining) {
                const targetHiragana = wanakana.toHiragana(remaining);
                
                if (targetHiragana.startsWith(kana)) {
                    return kana.length;
                }
                
                // éƒ¨åˆ†ä¸€è‡´ã®å ´åˆ
                if (kana.length === 1 && targetHiragana.length > 1) {
                    const firstChar = targetHiragana.charAt(0);
                    if (kana === firstChar) {
                        const nextChar = targetHiragana.charAt(1);
                        if (nextChar && 'ããƒã…ã‡ã‰ã‚ƒã‚…ã‚‡ã‚¡ã‚£ã‚¥ã‚§ã‚©ãƒ£ãƒ¥ãƒ§'.includes(nextChar)) {
                            return 0; // è¤‡åˆæ–‡å­—ã®é€”ä¸­ãªã®ã§ã€ã¾ã ãƒãƒƒãƒã—ãªã„
                        }
                        return 1;
                    }
                }
                
                return 0;
            }
            
            // â˜…æ–°ã—ã„ãƒ­ã‚¸ãƒƒã‚¯: ãƒ­ãƒ¼ãƒå­—ã‚¬ã‚¤ãƒ‰ã®è¡¨ç¤ºã‚’æ›´æ–°
            updateRomajiGuide() {
                let typedHTML = '';
                // å®Œäº†ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³
                for (let i = 0; i < this.currentTokenIndex; i++) {
                    typedHTML += wanakana.toRomaji(this.sentenceTokens[i].value);
                }
                
                let remainingHTML = '';
                if (this.currentTokenIndex < this.sentenceTokens.length) {
                    const currentToken = this.sentenceTokens[this.currentTokenIndex];
                    // ç¾åœ¨ã®ãƒˆãƒ¼ã‚¯ãƒ³ã®å…¥åŠ›æ¸ˆã¿éƒ¨åˆ†
                    typedHTML += wanakana.toRomaji(currentToken.typed);
                    
                    // ç¾åœ¨ã®ãƒˆãƒ¼ã‚¯ãƒ³ã®æœªå…¥åŠ›éƒ¨åˆ†
                    remainingHTML = `<span class="current-buffer">${this.romajiBuffer}</span>` + wanakana.toRomaji(currentToken.remaining);
                    
                    // æœªå®Œäº†ã®ãƒˆãƒ¼ã‚¯ãƒ³
                    for (let i = this.currentTokenIndex + 1; i < this.sentenceTokens.length; i++) {
                        remainingHTML += wanakana.toRomaji(this.sentenceTokens[i].value);
                    }
                }
                
                this.romajiGuideElement.innerHTML = `<span class="success">${typedHTML}</span>${remainingHTML}`;
                this.typingInput.value = typedHTML + this.romajiBuffer; // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚‚åæ˜ 
            }

            startTimer() {
                clearInterval(this.timer);
                this.timer = setInterval(() => {
                    this.timeLeft--;
                    if (this.timeLeft <= 0) {
                        this.endGame();
                    }
                    this.updateDisplay();
                }, 1000);
            }
            
            endGame() {
                this.isGameActive = false;
                clearInterval(this.timer);
                
                // ã‚²ãƒ¼ãƒ çµæœã®è©³ç´°è¨ˆç®—
                const gameResults = this.calculateGameResults();
                
                this.finalCorrectElement.textContent = this.correctTypes;
                this.finalMissElement.textContent = this.missTypes;
                
                // æ–°ã—ã„çµæœè¡¨ç¤ºã‚’è¿½åŠ 
                this.displayDetailedResults(gameResults);
                
                this.gameScreen.style.display = 'none';
                this.resultScreen.style.display = 'block';
            }
            
            // ã‚²ãƒ¼ãƒ çµæœã®è©³ç´°è¨ˆç®—
            calculateGameResults() {
                const totalTime = 120; // åˆ¶é™æ™‚é–“ï¼ˆç§’ï¼‰
                const elapsedTime = totalTime - this.timeLeft;
                
                // KPSï¼ˆKeys Per Secondï¼‰è¨ˆç®—
                const kps = elapsedTime > 0 ? (this.correctTypes / elapsedTime) : 0;
                
                // ãƒŸã‚¹ç‡è¨ˆç®—
                const totalTypes = this.correctTypes + this.missTypes;
                const missRate = totalTypes > 0 ? (this.missTypes / totalTypes) * 100 : 0;
                
                // æ­£ç¢ºæ€§ï¼ˆ100% - ãƒŸã‚¹ç‡ï¼‰
                const accuracy = 100 - missRate;
                
                // ãƒ©ãƒ³ã‚¯åˆ¤å®š
                const rank = this.calculateRank(kps, accuracy);
                
                return {
                    kps: Math.round(kps * 100) / 100, // å°æ•°ç‚¹2æ¡
                    missRate: Math.round(missRate * 100) / 100,
                    accuracy: Math.round(accuracy * 100) / 100,
                    rank: rank,
                    elapsedTime: elapsedTime
                };
            }
            
            // ãƒ©ãƒ³ã‚¯åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
            calculateRank(kps, accuracy) {
                // SSS: KPS 5.0ä»¥ä¸Š & æ­£ç¢ºæ€§ 99%ä»¥ä¸Š
                if (kps >= 5.0 && accuracy >= 99) return 'SSS';
                
                // SS: KPS 4.5ä»¥ä¸Š & æ­£ç¢ºæ€§ 97%ä»¥ä¸Š
                if (kps >= 4.5 && accuracy >= 97) return 'SS';
                
                // S: KPS 4.0ä»¥ä¸Š & æ­£ç¢ºæ€§ 95%ä»¥ä¸Š
                if (kps >= 4.0 && accuracy >= 95) return 'S';
                
                // A: KPS 3.5ä»¥ä¸Š & æ­£ç¢ºæ€§ 90%ä»¥ä¸Š
                if (kps >= 3.5 && accuracy >= 90) return 'A';
                
                // B: KPS 3.0ä»¥ä¸Š & æ­£ç¢ºæ€§ 85%ä»¥ä¸Š
                if (kps >= 3.0 && accuracy >= 85) return 'B';
                
                // C: KPS 2.5ä»¥ä¸Š & æ­£ç¢ºæ€§ 80%ä»¥ä¸Š
                if (kps >= 2.5 && accuracy >= 80) return 'C';
                
                // D: KPS 2.0ä»¥ä¸Š & æ­£ç¢ºæ€§ 70%ä»¥ä¸Š
                if (kps >= 2.0 && accuracy >= 70) return 'D';
                
                // E: ãã‚Œä»¥ä¸‹
                return 'E';
            }
            
            // è©³ç´°çµæœã‚’ç”»é¢ã«è¡¨ç¤º
            displayDetailedResults(results) {
                // ãƒ©ãƒ³ã‚¯è¡¨ç¤º
                this.finalRankElement.textContent = results.rank;
                this.finalRankElement.className = `rank-value rank-${results.rank.toLowerCase()}`;
                
                // è©³ç´°çµ±è¨ˆè¡¨ç¤º
                this.finalKpsElement.textContent = `${results.kps.toFixed(2)}/ç§’`;
                this.finalAccuracyElement.textContent = `${results.accuracy.toFixed(1)}%`;
                this.finalMissRateElement.textContent = `${results.missRate.toFixed(1)}%`;
                
                // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è©³ç´°æƒ…å ±ã‚’å‡ºåŠ›
                console.log('=== ã‚²ãƒ¼ãƒ çµæœ ===');
                console.log(`ãƒ©ãƒ³ã‚¯: ${results.rank}`);
                console.log(`KPS: ${results.kps.toFixed(2)}`);
                console.log(`æ­£ç¢ºæ€§: ${results.accuracy.toFixed(1)}%`);
                console.log(`ãƒŸã‚¹ç‡: ${results.missRate.toFixed(1)}%`);
                console.log(`çµŒéæ™‚é–“: ${results.elapsedTime}ç§’`);
                console.log('==================');
            }
            
            updateDisplay() {
                this.timerElement.textContent = this.timeLeft;
                this.correctElement.textContent = this.correctTypes;
                this.missElement.textContent = this.missTypes;
            }
            
            // é‡ã¿ä»˜ããƒ©ãƒ³ãƒ€ãƒ é¸æŠï¼ˆæ¥­å‹™ä¼šè©±ã‚’é«˜é »åº¦ã§å‡ºé¡Œã€é‡è¤‡ãªã—ï¼‰
            getWeightedRandomSentenceIndex() {
                if (!this.sentences || this.sentences.length === 0) {
                    return 0;
                }
                
                // æœªä½¿ç”¨ã®æ–‡ç« ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                const unusedSentences = this.sentences.filter(sentence => 
                    !this.usedSentenceIds.has(sentence.id)
                );
                
                // å…¨ã¦ã®æ–‡ç« ã‚’ä½¿ã„åˆ‡ã£ãŸå ´åˆã¯ä½¿ç”¨æ¸ˆã¿ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
                if (unusedSentences.length === 0) {
                    console.log('ğŸ”„ å…¨ã¦ã®æ–‡ç« ã‚’ä½¿ã„åˆ‡ã‚Šã¾ã—ãŸã€‚ãƒªã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚');
                    this.usedSentenceIds.clear();
                    return this.getWeightedRandomSentenceIndex(); // å†å¸°å‘¼ã³å‡ºã—
                }
                
                // æœªä½¿ç”¨æ–‡ç« ã®é‡ã¿è¨­å®š
                const weights = unusedSentences.map(sentence => {
                    // ID 50ä»¥é™ï¼ˆæ¥­å‹™ä¼šè©±ï¼‰ã¯é‡ã¿3å€ã€ãã‚Œä»¥å¤–ã¯é‡ã¿1
                    return sentence.id >= 50 ? 3 : 1;
                });
                
                // ç´¯ç©é‡ã¿ã‚’è¨ˆç®—
                const totalWeight = weights.reduce((sum, weight) => sum + weight, 0);
                let randomValue = Math.random() * totalWeight;
                
                // é‡ã¿ä»˜ããƒ©ãƒ³ãƒ€ãƒ é¸æŠ
                for (let i = 0; i < weights.length; i++) {
                    randomValue -= weights[i];
                    if (randomValue <= 0) {
                        // æœªä½¿ç”¨æ–‡ç« ã‹ã‚‰é¸æŠã•ã‚ŒãŸã‚‚ã®ã®å…ƒã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿”ã™
                        const selectedSentence = unusedSentences[i];
                        return this.sentences.findIndex(sentence => sentence.id === selectedSentence.id);
                    }
                }
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆé€šå¸¸ã¯åˆ°é”ã—ãªã„ï¼‰
                const selectedSentence = unusedSentences[unusedSentences.length - 1];
                return this.sentences.findIndex(sentence => sentence.id === selectedSentence.id);
            }
            
            // é€²æ—ãƒãƒ¼ã‚’æ›´æ–°
            updateProgressBar() {
                if (!this.sentenceTokens || this.sentenceTokens.length === 0) {
                    this.progressFillElement.style.width = '0%';
                    return;
                }
                
                // å®Œäº†ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’è¨ˆç®—
                let completedTokens = this.currentTokenIndex;
                
                // ç¾åœ¨ã®ãƒˆãƒ¼ã‚¯ãƒ³ã®é€²æ—ã‚‚è€ƒæ…®
                if (this.currentTokenIndex < this.sentenceTokens.length) {
                    const currentToken = this.sentenceTokens[this.currentTokenIndex];
                    if (currentToken && currentToken.value) {
                        const tokenProgress = currentToken.typed.length / currentToken.value.length;
                        completedTokens += tokenProgress;
                    }
                }
                
                // é€²æ—ç‡ã‚’è¨ˆç®—ï¼ˆ0-100%ï¼‰
                const progressPercentage = Math.min((completedTokens / this.sentenceTokens.length) * 100, 100);
                
                // é€²æ—ãƒãƒ¼ã‚’æ›´æ–°
                this.progressFillElement.style.width = `${progressPercentage}%`;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new SimpleTypingGame();
        });
    </script>
</body>
</html>
